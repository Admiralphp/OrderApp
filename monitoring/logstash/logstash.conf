input {
  # TCP input for structured logs
  tcp {
    port => 5000
    codec => json
  }

  # UDP input for syslog
  udp {
    port => 5000
    codec => json
  }

  # Beats input (if using Filebeat)
  beats {
    port => 5044
  }
}

filter {
  # Parse JSON logs
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
    }
  }

  # Add service identification
  if [service] {
    mutate {
      add_field => { "[@metadata][service]" => "%{service}" }
    }
  }

  # Parse log levels
  if [level] {
    mutate {
      uppercase => [ "level" ]
    }
  }

  # Extract user info from JWT tokens (if present in logs)
  if [userId] {
    mutate {
      add_field => { "user_id" => "%{userId}" }
    }
  }

  # Add timestamp if not present
  if ![timestamp] and [time] {
    mutate {
      rename => { "time" => "timestamp" }
    }
  }

  # Parse HTTP request information
  if [method] and [url] and [statusCode] {
    mutate {
      add_field => {
        "http_method" => "%{method}"
        "http_url" => "%{url}"
        "http_status_code" => "%{statusCode}"
      }
    }
  }

  # Tag critical errors
  if [level] == "ERROR" or [level] == "CRITICAL" {
    mutate {
      add_tag => [ "critical_error" ]
    }
  }

  # Tag slow requests (response time > 1s)
  if [responseTime] {
    if [responseTime] > 1000 {
      mutate {
        add_tag => [ "slow_request" ]
      }
    }
  }

  # Parse correlation IDs
  if [correlationId] or [requestId] or [traceId] {
    mutate {
      add_field => { "trace_id" => "%{[correlationId]}" }
    }
  }

  # Geolocation (if IP is present)
  if [clientIp] {
    geoip {
      source => "clientIp"
      target => "geoip"
    }
  }

  # Remove unnecessary fields
  mutate {
    remove_field => [ "host", "agent", "ecs", "tags" ]
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "orderapp-%{+YYYY.MM.dd}"
    template_name => "orderapp"
  }

  # Output to stdout for debugging (comment out in production)
  # stdout {
  #   codec => rubydebug
  # }
}
